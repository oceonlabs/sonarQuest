{"version":3,"file":"envOnly.js","sources":["../../../src/start-compiler-plugin/envOnly.ts"],"sourcesContent":["import * as t from '@babel/types'\nimport type * as babel from '@babel/core'\n\nimport type { CompileOptions } from './compilers'\n\nfunction capitalize(str: string) {\n  if (!str) return ''\n  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase()\n}\n\nfunction buildEnvOnlyCallExpressionHandler(env: 'client' | 'server') {\n  return function envOnlyCallExpressionHandler(\n    path: babel.NodePath<t.CallExpression>,\n    opts: CompileOptions,\n  ) {\n    // if (debug)\n    //   console.info(`Handling ${env}Only call expression:`, path.toString())\n\n    const isEnvMatch =\n      env === 'client' ? opts.env === 'client' : opts.env === 'server'\n\n    if (isEnvMatch) {\n      // extract the inner function from the call expression\n      const innerInputExpression = path.node.arguments[0]\n\n      if (!t.isExpression(innerInputExpression)) {\n        throw new Error(\n          `${env}Only() functions must be called with a function!`,\n        )\n      }\n\n      path.replaceWith(innerInputExpression)\n      return\n    }\n\n    // If we're on the wrong environment, replace the call expression\n    // with a function that always throws an error.\n    path.replaceWith(\n      t.arrowFunctionExpression(\n        [],\n        t.blockStatement([\n          t.throwStatement(\n            t.newExpression(t.identifier('Error'), [\n              t.stringLiteral(\n                `create${capitalize(env)}OnlyFn() functions can only be called on the ${env}!`,\n              ),\n            ]),\n          ),\n        ]),\n      ),\n    )\n  }\n}\n\nexport const handleCreateServerOnlyFnCallExpression =\n  buildEnvOnlyCallExpressionHandler('server')\nexport const handleCreateClientOnlyFnCallExpression =\n  buildEnvOnlyCallExpressionHandler('client')\n"],"names":[],"mappings":";AAKA,SAAS,WAAW,KAAa;AAC/B,MAAI,CAAC,IAAK,QAAO;AACjB,SAAO,IAAI,OAAO,CAAC,EAAE,gBAAgB,IAAI,MAAM,CAAC,EAAE,YAAA;AACpD;AAEA,SAAS,kCAAkC,KAA0B;AACnE,SAAO,SAAS,6BACd,MACA,MACA;AAIA,UAAM,aACJ,QAAQ,WAAW,KAAK,QAAQ,WAAW,KAAK,QAAQ;AAE1D,QAAI,YAAY;AAEd,YAAM,uBAAuB,KAAK,KAAK,UAAU,CAAC;AAElD,UAAI,CAAC,EAAE,aAAa,oBAAoB,GAAG;AACzC,cAAM,IAAI;AAAA,UACR,GAAG,GAAG;AAAA,QAAA;AAAA,MAEV;AAEA,WAAK,YAAY,oBAAoB;AACrC;AAAA,IACF;AAIA,SAAK;AAAA,MACH,EAAE;AAAA,QACA,CAAA;AAAA,QACA,EAAE,eAAe;AAAA,UACf,EAAE;AAAA,YACA,EAAE,cAAc,EAAE,WAAW,OAAO,GAAG;AAAA,cACrC,EAAE;AAAA,gBACA,SAAS,WAAW,GAAG,CAAC,gDAAgD,GAAG;AAAA,cAAA;AAAA,YAC7E,CACD;AAAA,UAAA;AAAA,QACH,CACD;AAAA,MAAA;AAAA,IACH;AAAA,EAEJ;AACF;AAEO,MAAM,yCACX,kCAAkC,QAAQ;AACrC,MAAM,yCACX,kCAAkC,QAAQ;"}